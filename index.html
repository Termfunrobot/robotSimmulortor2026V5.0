<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAMART Robotics thailand  Simulator Arduino Edition</title>
<style>
    /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Light Mode) */
    :root {
        --bg-body: #cccccc;
        --bg-field: #eeeeee;
        --bg-panel: #f5f5f5;
        --text-main: #000000;
        --border-color: #000000;
        --cell-border: #cccccc;
        --wall-color: #333333;
    }

    /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô (Dark Mode) */
    body.dark-mode {
        --bg-body: #1a1a1a;
        --bg-field: #2d2d2d;
        --bg-panel: #333333;
        --text-main: #ffffff;
        --border-color: #555555;
        --cell-border: #444444;
        --wall-color: #888888;
    }

    body { 
        text-align: center; 
        font-family: sans-serif; 
        background: var(--bg-body); 
        color: var(--text-main);
        transition: background 0.3s, color 0.3s;
        margin: 0;
        padding: 20px;
    }

    #field { 
        position: relative; 
        width: 1200px; 
        height: 600px; 
        background: var(--bg-field); 
        border: 3px solid var(--border-color); 
        margin: 0 auto; 
        overflow: hidden;
        transition: background 0.3s, border-color 0.3s;
    }

    .cell { 
        position: absolute; 
        width: 150px; 
        height: 150px; 
        box-sizing: border-box; 
        border: 1px solid var(--cell-border); 
    }

    .start-spot { position: absolute; width: 140px; height: 140px; background: #ff4d4d; z-index: 0; }
    .green-spot { position: absolute; background: #7CFC00; border-radius: 8px; z-index: 1; opacity: 0.8; }
    .wall-edge { position: absolute; background: var(--wall-color); z-index: 2; transition: background 0.3s; }
    
    .box { 
        position: absolute; width: 24px; height: 24px; background: orange; 
        border: 2px solid #aa5500; border-radius: 4px; z-index: 4; transition: 0.1s; 
    }

    #robot { 
        width: 60px; height: 65px; background: linear-gradient(#1e90ff,#0b4fa3); 
        border: 2px solid #000; border-radius: 8px; position: absolute; 
        transform-origin: center; transition: 0.2s; z-index: 5; 
    }
    
    .head { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 50%; height: 30px; background: #000; border-radius: 5px; }

    .wheel { 
        position: absolute; width: 16px; height: 50px; 
        background: repeating-linear-gradient(#111, #111 8px, #333 5px, #333 10px); 
        bottom: 5px; border-radius: 3px; border: 1px solid #000;
    }
    .wheel.left { left: -10px; }
    .wheel.right { right: -10px; }

    .yellow-spot {
        position: absolute; width: 50px; height: 50px; background: #ffcc00; 
        border: 3px solid #000; border-radius: 50%; z-index: 1; transition: transform 0.3s, opacity 0.3s;
    }

    @keyframes hitFlash { 0% { background: red; } 50% { background: #ff4444; } 100% { background: linear-gradient(#1e90ff,#0b4fa3); } }
    .hit { animation: hitFlash 0.3s; }

    .top-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        min-height: 60px;
    }

    .score-display {
        background: var(--bg-panel);
        padding: 10px 25px;
        border-radius: 12px;
        border: 2px solid var(--border-color);
        font-size: 28px;
        font-weight: bold;
        display: flex;
        gap: 25px;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .control-area {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .hidden {
        display: none !important;
    }

    .button-group {
        margin-bottom: 5px;
    }

    .editor-container {
        display: flex;
        gap: 20px;
        justify-content: center;
        align-items: flex-start;
        width: 100%;
        max-width: 1200px;
    }

    textarea { 
        flex: 1;
        height: 200px; 
        font-size: 16px; 
        font-family: monospace; 
        padding: 15px; 
        border-radius: 12px; 
        border: 2px solid var(--border-color);
        background: var(--bg-panel); 
        color: var(--text-main);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        resize: none;
    }

    .side-panel { 
        width: 320px; 
        height: 200px;
        text-align: left; 
        background: var(--bg-panel); 
        padding: 15px; 
        border-radius: 12px; 
        border: 2px solid var(--border-color); 
        transition: background 0.3s, border-color 0.3s;
        overflow-y: auto;
        box-sizing: border-box;
    }

    .side-panel h3 { margin-top: 0; margin-bottom: 10px; font-size: 16px; border-bottom: 1px solid var(--cell-border); padding-bottom: 5px; }
    .side-panel p { margin: 8px 0; font-size: 14px; }

    button { 
        margin: 3px; padding: 10px 25px; cursor: pointer; border-radius: 8px; 
        border: 1px solid rgba(0,0,0,0.1); font-weight: bold;
        transition: transform 0.1s, filter 0.2s;
    }
    button:active { transform: scale(0.95); }

    .btn-run { background: #28a745; color: white; border: none; font-size: 18px; }
    .btn-loop { background: #17a2b8; color: white; border: none; font-size: 18px; }
    
    .btn-reset { 
        background: #ffc107; 
        color: #000; 
        border: none; 
        font-size: 18px; 
    }
    .btn-reset:hover { filter: brightness(1.1); }

    .btn-start {
        background: #007bff;
        color: white;
        border: none;
        font-size: 18px;
        box-shadow: 0 4px 0 #0056b3;
    }
    .btn-start:active { transform: translateY(4px); box-shadow: none; }

    .theme-toggle {
        position: fixed; top: 20px; right: 20px; padding: 10px 20px;
        background: #444; color: white; border: none; border-radius: 50px;
        cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 100;
    }
    body.dark-mode .theme-toggle { background: #eee; color: #333; }

    code { background: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 4px; font-weight: bold; }
    body.dark-mode code { background: rgba(255,255,255,0.1); }
    
    .info-text { font-size: 14px; opacity: 0.8; margin-top: 10px; display: block; }
</style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô</button>

<h2>SMR Robot simulator Arduino Edition 2026</h2>

<div class="top-controls">
    <div id="setupControls">
        <input type="number" id="wallPercent" value="25" min="10" max="50" style="padding: 8px; border-radius: 6px; width: 60px;"> % 
        <button onclick="randomGreenCells()">‡∏™‡∏∏‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</button>
        <button onclick="randomYellowSpot()">üü° ‡∏™‡∏∏‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°</button>
        <button onclick="generateWalls()">‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≥‡πÅ‡∏û‡∏á</button>
        <button onclick="startMission()" class="btn-start">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
    </div>
    
    <div class="score-display">
        <div title="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="scoreText" style="color: #28a745;">0</span></div>
        <div style="font-size: 20px; border-left: 2px solid var(--cell-border); padding-left: 20px;">
            ‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏®‡∏Å‡πå: <span id="ammoCount">4</span>
        </div>
        <div id="roundDisplay" style="font-size: 16px; color: #17a2b8; border-left: 2px solid var(--cell-border); padding-left: 20px;">
            ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà: <span id="roundText">1</span>
        </div>
    </div>
</div>

<div id="field"></div>

<span class="info-text">SMR V6.0 (2026) - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå  ‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏≠‡∏î‡πÑ‡∏•‡∏ô‡πå ‡∏≠.‡∏ß‡∏∏‡∏í‡∏¥ 0847999639 </span>

<div class="control-area hidden" id="codingArea">
    <div class="button-group">
        <button onclick="runCommands()" class="btn-run">‚ñ∂ RUN CODE</button>
        <button id="loopBtn" onclick="toggleLoop()" class="btn-loop">üîÑ START LOOP</button>
        <button onclick="manualReset()" class="btn-reset">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </div>

    <div class="editor-container">
        <textarea id="commandInput">GO1();
GO1();
RR90();
JY1();</textarea>
        
        <div class="side-panel">
            <h3>üìò Arduino Commands</h3>
            <p><code>GO1();</code> ‚Üí ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤</p>
            <p><code>LL90();</code> ‚Üí ‡∏´‡∏°‡∏∏‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ 90¬∞</p>
            <p><code>RR90();</code> ‚Üí ‡∏´‡∏°‡∏∏‡∏ô‡∏Ç‡∏ß‡∏≤ 90¬∞</p>
            <p><code>BK();</code> ‚Üí ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
            <p><code>JY1();</code> ‚Üí ‡∏à‡πà‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏®‡∏Å‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤</p>
            <div style="margin-top: 10px; padding: 10px; border-radius: 8px; background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745;">
                <p style="color: #28a745; font-weight: bold; margin: 0;">üéØ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</p>
                <p style="font-size: 13px; margin: 4px 0 0 0;">‚Ä¢ ‡∏ß‡∏¥‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á: <b>+5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</b></p>
                <p style="font-size: 13px; margin: 2px 0 0 0;">‚Ä¢ ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏£‡∏ö 4 ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß + ‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å: <b>+10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</b></p>
            </div>
        </div>
    </div>
</div>

<script>
const field = document.getElementById("field");
let row=3, col=0, direction=0;
let wallEdges=[], greenCells=[], ammo=4, score=0, running=false, loopActive=false;
let roundCount = 1;
let returnBonus = 0; // ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
let bonusClaimed = false; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

// --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(freq, type, duration, vol = 0.1) {
    try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    } catch(e) {}
}

function moveSound() { playSound(400, "sine", 0.1, 0.05); }
function turnSound() { playSound(300, "triangle", 0.15, 0.05); }
function scoreSound() {
    playSound(600, "sine", 0.3, 0.1);
    setTimeout(() => playSound(800, "sine", 0.3, 0.1), 100);
}

function startMission() {
    document.getElementById("setupControls").classList.add("hidden");
    document.getElementById("codingArea").classList.remove("hidden");
    roundCount = 1;
    updateRoundUI();
    if(audioCtx.state === 'suspended') audioCtx.resume();
}

function toggleTheme() {
    const body = document.body;
    const btn = document.getElementById("themeBtn");
    body.classList.toggle("dark-mode");
    btn.innerHTML = body.classList.contains("dark-mode") ? "‚òÄÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô" : "üåô ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô";
}

for(let r=0;r<4;r++){
    for(let c=0;c<8;c++){
        let cell=document.createElement("div");
        cell.className="cell";
        cell.style.left=(c*150)+"px"; cell.style.top=(r*150)+"px";
        field.appendChild(cell);
    }
}

let startSpot = document.createElement("div");
startSpot.className = "start-spot";
let offset = (150 - 140) / 2; 
startSpot.style.left = (0 * 150 + offset) + "px"; 
startSpot.style.top = (3 * 150 + offset) + "px";
field.appendChild(startSpot);

const robot=document.createElement("div");
robot.id="robot";
robot.innerHTML='<div class="head"></div><div class="wheel left"></div><div class="wheel right"></div>';
field.appendChild(robot);

function updateRobot(){
    robot.style.left=(col*150+45)+"px";
    robot.style.top=(row*150+45)+"px";
    robot.style.transform="rotate("+direction+"deg)";
}

function updateRoundUI() {
    document.getElementById("roundText").innerText = roundCount;
}

function resetGame(){
    row=3; col=0; direction=0; updateRobot();
    ammo=4; score=0; 
    returnBonus = 0;
    bonusClaimed = false;
    document.getElementById("ammoCount").innerText=ammo;
    document.getElementById("scoreText").innerText=score;
    if(!loopActive) {
        const loopBtn = document.getElementById("loopBtn");
        loopBtn.innerText = "üîÑ START LOOP";
        loopBtn.style.background = "#17a2b8";
    }
    document.querySelectorAll(".box").forEach(b=>b.remove());
    document.querySelectorAll(".yellow-spot").forEach(y => {
        y.style.display = "block";
        y.style.opacity = "1";
        y.style.transform = "scale(1)";
        y.dataset.collected = "false";
    });
    updateRoundUI();
}

function manualReset() {
    roundCount = 1;
    resetGame();
}

function randomGreenCells(){
    greenCells=[];
    document.querySelectorAll(".green-spot").forEach(g=>g.remove());
    let edgeCells = [];
    for(let r=0; r<4; r++){
        for(let c=0; c<8; c++){
            if(r === 0 || r === 3 || c === 0 || c === 7){
                if(!(r === 3 && c === 0)) edgeCells.push({r: r, c: c});
            }
        }
    }
    while(greenCells.length < 4 && edgeCells.length > 0){
        let randomIndex = Math.floor(Math.random() * edgeCells.length);
        let selected = edgeCells.splice(randomIndex, 1)[0]; 
        let spot = document.createElement("div");
        spot.className = "green-spot";
        let r = selected.r, c = selected.c;
        let leftPos = c * 150, topPos = r * 150, w, h;
        if (r === 0) { w = 150; h = 75; topPos = r * 150; } 
        else if (r === 3) { w = 150; h = 75; topPos = r * 150 + 75; } 
        else if (c === 0) { w = 75; h = 150; leftPos = c * 150; } 
        else if (c === 7) { w = 75; h = 150; leftPos = c * 150 + 75; }
        spot.style.width = w + "px"; spot.style.height = h + "px";
        spot.style.left = leftPos + "px"; spot.style.top = topPos + "px";
        field.appendChild(spot);
        greenCells.push({row: r, col: c});
    }
}

function generateWalls() {
    let percent = parseInt(document.getElementById("wallPercent").value) / 100;
    let isPathValid = false;
    let attempts = 0;
    while (!isPathValid && attempts < 100) {
        attempts++;
        document.querySelectorAll(".wall-edge").forEach(w => w.remove());
        wallEdges = [];
        for (let r = 0; r < 4; r++) {
            for (let c = 0; c < 8; c++) {
                if (Math.random() < percent) {
                    let lTypes = [["right", "bottom"], ["right", "top"], ["left", "bottom"], ["left", "top"]];
                    let chosenL = lTypes[Math.floor(Math.random() * lTypes.length)];
                    addWall(r, c, chosenL[0]); addWall(r, c, chosenL[1]);
                }
            }
        }
        greenCells.forEach(gc => {
            if (gc.row === 0 || gc.row === 3) { addWall(gc.row, gc.col, "left"); addWall(gc.row, gc.col, "right"); } 
            else if (gc.col === 0 || gc.col === 7) { addWall(gc.row, gc.col, "top"); addWall(gc.row, gc.col, "bottom"); }
        });
        for (let r = 0; r < 4; r++) { addWall(r, 0, "left"); addWall(r, 7, "right"); }
        for (let c = 0; c < 8; c++) { addWall(0, c, "top"); addWall(3, c, "bottom"); }
        wallEdges = wallEdges.filter(w => !(w.row === 3 && w.col === 0 && w.side === "top"));
        isPathValid = checkAllCellsReachable();
    }
}

function randomYellowSpot() {
    document.querySelectorAll(".yellow-spot").forEach(y => y.remove());
    let count = 0, attempts = 0, selectedPositions = [];
    while (count < 2 && attempts < 100) {
        attempts++;
        let yelR = Math.floor(Math.random() * 4), yelC = Math.floor(Math.random() * 8);
        const isStart = (yelR === 3 && yelC === 0);
        const isGreen = greenCells.some(gc => gc.row === yelR && gc.col === yelC);
        const isDuplicate = selectedPositions.some(p => p.r === yelR && p.c === yelC);
        if (!isStart && !isGreen && !isDuplicate) {
            selectedPositions.push({r: yelR, c: yelC});
            let yellow = document.createElement("div");
            yellow.className = "yellow-spot";
            yellow.style.left = (yelC * 150 + 50) + "px"; yellow.style.top = (yelR * 150 + 50) + "px";
            yellow.dataset.row = yelR; yellow.dataset.col = yelC; yellow.dataset.collected = "false";
            field.appendChild(yellow);
            count++;
        }
    }
}

function checkAllCellsReachable() {
    let visited = new Set();
    let queue = [{ r: 3, c: 0 }];
    visited.add("3,0");
    while (queue.length > 0) {
        let { r, c } = queue.shift();
        let dirs = [
            { dr: -1, dc: 0, side: "top", opp: "bottom" },
            { dr: 0, dc: 1, side: "right", opp: "left" },
            { dr: 1, dc: 0, side: "bottom", opp: "top" },
            { dr: 0, dc: -1, side: "left", opp: "right" }
        ];
        for (let d of dirs) {
            let nr = r + d.dr, nc = c + d.dc;
            let key = `${nr},${nc}`;
            if (nr >= 0 && nr < 4 && nc >= 0 && nc < 8 && !visited.has(key)) {
                if (!hasWall(r, c, d.side) && !hasWall(nr, nc, d.opp)) {
                    visited.add(key); queue.push({ r: nr, c: nc });
                }
            }
        }
    }
    return greenCells.every(gc => visited.has(`${gc.row},${gc.col}`));
}

function addWall(r,c,side){
    let wall=document.createElement("div"); wall.className="wall-edge";
    if(side==="right"){ wall.style.width="6px"; wall.style.height="150px"; wall.style.left=(c*150+144)+"px"; wall.style.top=(r*150)+"px"; }
    if(side==="bottom"){ wall.style.width="150px"; wall.style.height="6px"; wall.style.left=(c*150)+"px"; wall.style.top=(r*150+144)+"px"; }
    if(side==="left"){ wall.style.width="6px"; wall.style.height="150px"; wall.style.left=(c*150)+"px"; wall.style.top=(r*150)+"px"; }
    if(side==="top"){ wall.style.width="150px"; wall.style.height="6px"; wall.style.left=(c*150)+"px"; wall.style.top=(r*150)+"px"; }
    field.appendChild(wall); wallEdges.push({row:r,col:c,side:side});
}

function hasWall(r,c,side){ return wallEdges.some(w=>w.row===r && w.col===c && w.side===side); }

function hitEffect(){
    playSound(150, "square", 0.2, 0.1);
    robot.classList.add("hit"); setTimeout(()=>robot.classList.remove("hit"),300);
}

function moveForward(){
    let nr=row, nc=col;
    if(direction===0){ if(hasWall(row,col,"top")) return hitEffect(); nr--; }
    if(direction===90){ if(hasWall(row,col,"right")) return hitEffect(); nc++; }
    if(direction===180){ if(hasWall(row,col,"bottom")) return hitEffect(); nr++; }
    if(direction===270){ if(hasWall(row,col,"left")) return hitEffect(); nc--; }
    if(nr<0||nr>=4||nc<0||nc>=8){ hitEffect(); return; }
    row=nr; col=nc; 
    moveSound(); 
    updateRobot();
    checkReturnBonus(); // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡πâ‡∏≤‡∏ß
}

function moveBackward(){ direction=(direction+180)%360; moveForward(); direction=(direction+180)%360; updateRobot(); }
function turnLeft(){ direction=(direction+270)%360; turnSound(); updateRobot(); checkReturnBonus(); }
function turnRight(){ direction=(direction+90)%360; turnSound(); updateRobot(); checkReturnBonus(); }

function dropBox(){
    if(ammo<=0) return;
    let tr=row, tc=col;
    if(direction===0) tr--; if(direction===90) tc++; if(direction===180) tr++; if(direction===270) tc--;
    let exists = Array.from(document.querySelectorAll(".box")).some(b => parseInt(b.dataset.row)===tr && parseInt(b.dataset.col)===tc);
    if(exists) return;
    let rx = col*150+45, ry = row*150+45, rs=60, bs=24, bx, by;
    if(direction===0){ bx=rx+(rs/2)-(bs/2); by=ry-bs; }
    else if(direction===90){ bx=rx+rs; by=ry+(rs/2)-(bs/2); }
    else if(direction === 180){ bx=rx+(rs/2)-(bs/2); by=ry+rs; }
    else { bx=rx-bs; by=ry+(rs/2)-(bs/2); }
    let box=document.createElement("div");
    box.className="box"; box.style.left=bx+"px"; box.style.top=by+"px";
    box.dataset.row=tr; box.dataset.col=tc;
    field.appendChild(box);
    ammo--; document.getElementById("ammoCount").innerText=ammo;
    playSound(200, "triangle", 0.2, 0.05);
}

function checkGreenScore() {
    let currentScore = 0;
    let allBoxes = document.querySelectorAll(".box");
    let allGreens = document.querySelectorAll(".green-spot");
    allBoxes.forEach(box => {
        let bRect = box.getBoundingClientRect();
        let isOverlapping = false;
        allGreens.forEach(green => {
            let gRect = green.getBoundingClientRect();
            let overlap = !(bRect.right < gRect.left || bRect.left > gRect.right || bRect.bottom < gRect.top || bRect.top > gRect.bottom);
            if (overlap) isOverlapping = true;
        });
        if (isOverlapping) { 
            if(box.style.background !== "rgb(34, 139, 34)") scoreSound();
            currentScore += 20; 
            box.style.background = "#228B22"; 
        } 
        else { box.style.background = "orange"; }
    });
    return currentScore;
}

function checkYellowScore() {
    const rRect = robot.getBoundingClientRect();
    const yellowSpots = document.querySelectorAll(".yellow-spot");
    yellowSpots.forEach(spot => {
        if (spot.dataset.collected === "false") {
            const sRect = spot.getBoundingClientRect();
            const overlap = !(rRect.right < sRect.left || rRect.left > sRect.right || rRect.bottom < sRect.top || rRect.top > sRect.bottom);
            if (overlap) {
                score += 5;
                scoreSound();
                document.getElementById("scoreText").innerText = score + checkGreenScore() + returnBonus;
                spot.dataset.collected = "true";
                spot.style.transform = "scale(1.5)";
                spot.style.opacity = "0";
                setTimeout(() => spot.style.display = "none", 300);
            }
        }
    });
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô ---
function checkReturnBonus() {
    if (bonusClaimed) return;

    let greenFilledCount = 0;
    document.querySelectorAll(".box").forEach(box => {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°) ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        if (box.style.background === "rgb(34, 139, 34)") greenFilledCount++;
    });

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (4 ‡∏à‡∏∏‡∏î) ‡πÅ‡∏•‡∏∞ ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (3, 0)
    if (greenFilledCount === 4 && row === 3 && col === 0) {
        returnBonus = 10;
        bonusClaimed = true;
        scoreSound();
        document.getElementById("scoreText").innerText = score + checkGreenScore() + returnBonus;
    }
}

async function runCommands(){
    if(running) return;
    running=true;
    let input = document.getElementById("commandInput").value.trim();
    let rawTokens = input.split(/[\s\n]+/); 
    for(let token of rawTokens){
        if(token === "" || (!loopActive && !running)) continue;
        let cmd = token.replace(/\(\);/i, "").toUpperCase();
        if(cmd==="GO1") moveForward(); 
        else if(cmd==="BK") moveBackward();
        else if(cmd==="LL90") turnLeft(); 
        else if(cmd==="RR90") turnRight();
        else if(cmd==="JY1") dropBox();
        
        let greenScore = checkGreenScore();
        document.getElementById("scoreText").innerText = score + greenScore + returnBonus;
        checkYellowScore();
        await sleep(500);
    }
    running=false;
}

async function toggleLoop() {
    const btn = document.getElementById("loopBtn");
    if (!loopActive) {
        loopActive = true;
        roundCount = 1;
        btn.innerText = "üõë STOP LOOP"; btn.style.background = "#dc3545";
        while (loopActive) {
            resetGame();
            loopActive = true; 
            btn.innerText = "üõë STOP LOOP"; btn.style.background = "#dc3545";
            await sleep(500);
            if (loopActive) {
                await runCommands(); 
                roundCount++;
            }
            await sleep(1000); 
            if (!loopActive) break;
        }
    } else {
        loopActive = false;
        btn.innerText = "üîÑ START LOOP"; btn.style.background = "#17a2b8";
    }
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
updateRobot(); randomGreenCells(); generateWalls();
</script>
</body>
</html>


